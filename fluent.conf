<source>
  @type tail
  path "/var/lib/docker/containers/*/*-json.log"
  read_from_head true
  pos_file "/fluentd/log/fluent-docker.pos"
  time_format %Y-%m-%dT%H:%M:%S
  tag "docker.*"
  read_lines_limit 5000
  format json
</source>

<filter docker.etc.fluent.log.*.*.log>
  @type docker_metadata
</filter>

<filter docker.**>
  @type record_transformer
  <record>
    log_type docker
    hostname_tru "#{Socket.gethostname}"
    environment "#{ENV['HOSTNAME_NODE']}"
  </record>
</filter>

<filter syslog.**>
  @type record_transformer
  <record>
    log_type syslog
    hostname_tru "#{Socket.gethostname}"
    environment "#{ENV['HOSTNAME_NODE']}"
  </record>
</filter>

### TO DO REGEXP ###


<match docker.**>
  @type rewrite_tag_filter
  <rule>
    key $['attrs']['tag']
    pattern ^(.+)$
    tag sorted.$1
  </rule>
</match>

<match **>
  @type elasticsearch
  host elasticsearch
  port 9300
  buffer_queue_limit 512m
  buffer_chunk_limit 32MB
  disable_retry_limit false
  retry_limit 5
  buffer_chunk_limit 5m
  include_tag_key true  
  logstash_prefix "fluentd"
  logstash_dateformat "%Y%m%d"
  tag_key "log_path"
  index_name "fluentd-%Y-%m-%d" 
  logstash_format true
  flush_interval 5s
  max_retry_wait 300s # ~5 minutes
  retry_limit 300
</match>
